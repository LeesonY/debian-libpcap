Description: CVE-2019-15165
 sf-pcapng.c in libpcap does not properly validate the PHB header length before
 allocating memory.

---
Author: Abhijith PA <abhijith@debian.org>
Bug-Debian: https://bugs.debian.org/941697
Origin: https://github.com/the-tcpdump-group/libpcap/commit/87d6bef033062f969e70fa40c43dfd945d5a20ab
	https://github.com/the-tcpdump-group/libpcap/commit/87d6bef033062f969e70fa40c43dfd945d5a20ab
Last-Update: 2019-10-17

Index: libpcap-1.6.2/sf-pcap-ng.c
===================================================================
--- libpcap-1.6.2.orig/sf-pcap-ng.c
+++ libpcap-1.6.2/sf-pcap-ng.c
@@ -20,7 +20,7 @@
  *
  * sf-pcap-ng.c - pcap-ng-file-format-specific code from savefile.c
  */
-
+#define BT_SHB_INSANE_MAX       1024U*1024U*1U  /* 1MB should be enough */
 #ifndef lint
 static const char rcsid[] _U_ =
     "@(#) $Header$ (LBL)";
@@ -243,7 +243,7 @@ read_bytes(FILE *fp, void *buf, size_t b
 			if (amt_read == 0 && !fail_on_eof)
 				return (0);	/* EOF */
 			snprintf(errbuf, PCAP_ERRBUF_SIZE,
-			    "truncated dump file; tried to read %lu bytes, only got %lu",
+			    "truncated pcapng dump file; tried to read %lu bytes, only got %lu",
 			    (unsigned long)bytes_to_read,
 			    (unsigned long)amt_read);
 		}
@@ -737,15 +737,18 @@ pcap_ng_check_header(bpf_u_int32 magic,
 	/*
 	 * Check the sanity of the total length.
 	 */
-	if (total_length < sizeof(*bhdrp) + sizeof(*shbp) + sizeof(struct block_trailer)) {
+	if (total_length < sizeof(*bhdrp) + sizeof(*shbp) + sizeof(struct block_trailer) ||
+		(total_length > BT_SHB_INSANE_MAX)) {
 		snprintf(errbuf, PCAP_ERRBUF_SIZE,
-		    "Section Header Block in pcap-ng dump file has a length of %u < %lu",
+		    "Section Header Block in pcapng dump file has invalid length  _%u_ < %u (BT_SHB_INSANE_MAX)",
+		    sizeof(*bhdrp) + sizeof(*shbp) + sizeof(struct block_trailer),
 		    total_length,
-		    (unsigned long)(sizeof(*bhdrp) + sizeof(*shbp) + sizeof(struct block_trailer)));
+		    BT_SHB_INSANE_MAX);
 		*err = 1;
 		return (NULL);
 	}
 
+
 	/*
 	 * OK, this is a good pcap-ng file.
 	 * Allocate a pcap_t for it.
